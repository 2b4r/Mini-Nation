<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Agar‑Lite Online</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<style>
  :root{--bg:#0f172a;--panel:#0b1220;--muted:#94a3b8;--border:#1f2937;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#fff;font:14px/1.5 system-ui,Segoe UI,Arial;overflow:hidden}
  .hud{position:fixed;top:8px;left:8px;display:flex;gap:8px;align-items:center}
  .pill{background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:#cbd5e1}
  .right{position:fixed;top:8px;right:8px;background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:8px;max-width:220px}
  #list{font-size:12px;color:#cbd5e1;max-height:40vh;overflow:auto}
  canvas{display:block;width:100vw;height:100vh}
  /* overlay */
  #join{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0008;backdrop-filter:blur(4px)}
  #card{background:#0b1220;border:1px solid var(--border);border-radius:16px;padding:16px;min-width:280px}
  input,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1b2f;color:#e2e8f0;margin-top:8px}
  button{cursor:pointer}
  .stick{position:fixed;bottom:18px;left:18px;width:110px;height:110px;border-radius:50%;border:1px solid #1f355a;background:#0b1220aa}
  .stick .dot{position:absolute;left:50%;top:50%;width:44px;height:44px;border-radius:50%;transform:translate(-50%,-50%);background:#06b6d4aa}
</style>
</head>
<body>
<div class="hud">
  <span id="fps" class="pill">— FPS</span>
  <span id="mePill" class="pill">أنا: —</span>
</div>
<div class="right">
  <div class="pill" style="display:inline-block">أونلاين: <b id="online">0</b></div>
  <div id="list"></div>
</div>
<canvas id="cv"></canvas>

<!-- join overlay -->
<div id="join">
  <div id="card">
    <h3 style="margin:0 0 6px">ادخل باسمك وابدأ اللعب</h3>
    <input id="name" placeholder="username" maxlength="16" />
    <button id="go">ادخل</button>
    <p style="color:#94a3b8;font-size:12px;margin-top:8px">التحكم: عصاية افتراضية (موبايل) أو الأسهم/WASD (كمبيوتر).</p>
  </div>
</div>

<!-- virtual stick -->
<div class="stick" id="stick" hidden><div class="dot" id="dot"></div></div>

<script>
const SERVER = "https://YOUR-APP-NAME.glitch.me"; // ← غيّرها لرابط السيرفر

// ===== Connect =====
let socket = null, myId = null, world = {w:2200,h:2200};

const cv = document.getElementById("cv"), ctx = cv.getContext("2d");
function resize(){ cv.width = innerWidth*devicePixelRatio; cv.height = innerHeight*devicePixelRatio; }
addEventListener("resize", resize, {passive:true}); resize();

const fpsEl = document.getElementById('fps');
const mePill = document.getElementById('mePill');
const onlineEl = document.getElementById('online');
const listEl = document.getElementById('list');

const state = { players: [], food: [] };
let me = null, cam = {x:0,y:0,zoom:1};

function connect(name){
  socket = io(SERVER, { transports: ["websocket"], timeout: 5000 });

  socket.on("connect", () => {
    socket.emit("join", { name });
  });
  socket.on("hello", (data) => { myId = data.id; world = data.world || world; });
  socket.on("online", ({count, list}) => {
    onlineEl.textContent = count;
    listEl.innerHTML = list.map(p => `<div>• ${escapeHtml(p.name)} — <small>score ${p.score}</small></div>`).join("");
  });
  socket.on("state", (s) => {
    state.players = s.players; state.food = s.food;
    me = state.players.find(p => p.id === myId) || me;
    if (me) mePill.textContent = `أنا: ${me.name} — score ${me.score}`;
  });
}

function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[m])); }

// ===== Input (keyboard + virtual stick) =====
const input = {dx:0, dy:0};
addEventListener("keydown", e => {
  if(["ArrowUp","w","W"].includes(e.key)) input.dy=-1;
  if(["ArrowDown","s","S"].includes(e.key)) input.dy= 1;
  if(["ArrowLeft","a","A"].includes(e.key)) input.dx=-1;
  if(["ArrowRight","d","D"].includes(e.key)) input.dx= 1;
  sendInput();
});
addEventListener("keyup", e => {
  if(["ArrowUp","w","W","ArrowDown","s","S"].includes(e.key)) input.dy=0;
  if(["ArrowLeft","a","A","ArrowRight","d","D"].includes(e.key)) input.dx=0;
  sendInput();
});

// Virtual joystick (mobile)
const stick = document.getElementById('stick'), dot = document.getElementById('dot');
let dragging=false, center={x:0,y:0};
function startStick(e){ dragging=true; stick.hidden=false; const t=e.touches?e.touches[0]:e; center={x:t.clientX,y:t.clientY}; stick.style.left=(center.x-55)+'px'; stick.style.top=(center.y-55)+'px'; moveStick(e); }
function moveStick(e){
  if(!dragging) return;
  const t=e.touches?e.touches[0]:e;
  const dx=t.clientX-center.x, dy=t.clientY-center.y;
  const len=Math.hypot(dx,dy); const max=40;
  const nx = len? dx/len : 0, ny = len? dy/len : 0;
  dot.style.transform=`translate(${(nx*max)}px, ${(ny*max)}px)`;
  input.dx = Math.max(-1, Math.min(1, nx));
  input.dy = Math.max(-1, Math.min(1, ny));
  sendInput();
}
function endStick(){ dragging=false; input.dx=input.dy=0; dot.style.transform='translate(-50%,-50%)'; stick.hidden=true; sendInput(); }
addEventListener('pointerdown', startStick);
addEventListener('pointermove', moveStick);
addEventListener('pointerup', endStick);
addEventListener('touchstart', startStick, {passive:false});
addEventListener('touchmove', moveStick, {passive:false});
addEventListener('touchend', endStick, {passive:false});

function sendInput(){
  if (socket && socket.connected) socket.emit("input", input);
}

// ===== Render =====
let last=performance.now(), frames=0, fps=0;
function loop(ts){
  frames++; if (ts-last>1000){ fps=frames; frames=0; last=ts; fpsEl.textContent=fps+" FPS"; }
  draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  // camera follows me
  let targetZoom = 1;
  if (me) {
    cam.x = me.x; cam.y = me.y;
    targetZoom = Math.max(0.4, Math.min(1.2, 80 / Math.sqrt(me.r)));
  }
  cam.zoom += (targetZoom - cam.zoom) * 0.1;

  const dpr = devicePixelRatio||1;
  ctx.save();
  ctx.translate(cv.width/2, cv.height/2);
  ctx.scale(cam.zoom*dpr, cam.zoom*dpr);
  ctx.translate(-cam.x, -cam.y);

  // background grid
  ctx.strokeStyle = "#0d1b2a";
  ctx.lineWidth = 1;
  for (let x=0;x<=world.w;x+=100){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,world.h); ctx.stroke(); }
  for (let y=0;y<=world.h;y+=100){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(world.w,y); ctx.stroke(); }

  // food
  for (const f of state.food){
    ctx.fillStyle = "#ffd166";
    ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
  }

  // players
  for (const p of state.players){
    ctx.save();
    ctx.shadowColor = p.color+"55"; ctx.shadowBlur = 12;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
    ctx.shadowBlur = 0;
    // name
    ctx.fillStyle = "#e2e8f0"; ctx.font = "bold 14px system-ui"; ctx.textAlign="center";
    ctx.fillText(p.name, p.x, p.y - p.r - 10);
    ctx.restore();
  }

  ctx.restore();
}

// ===== Join UI =====
document.getElementById('go').onclick = () => {
  const name = document.getElementById('name').value.trim() || "Player";
  document.getElementById('join').style.display = 'none';
  connect(name);
};
</script>
</body>
</html>
