<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Agar‑Lite (Bots)</title>
<style>
  :root{--bg:#0b1220;--panel:#0e1626;--muted:#9fb3c8;--border:#1f2b46;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:#e5f0ff;font:14px/1.5 system-ui,Segoe UI,Arial;overflow:hidden}
  canvas{display:block;width:100vw;height:100vh}
  .hud{position:fixed;top:8px;left:8px;display:flex;gap:8px;align-items:center;z-index:3}
  .pill{background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:#cfe6ff}
  .side{position:fixed;top:8px;right:8px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px 10px;z-index:3;max-width:240px}
  .muted{color:var(--muted)} .list{max-height:38vh;overflow:auto;font-size:12px}
  /* عصاية افتراضية */
  .stick{position:fixed;bottom:18px;left:18px;width:120px;height:120px;border-radius:50%;border:1px solid #29476f;background:#0c182b9a;z-index:4}
  .stick .dot{position:absolute;left:50%;top:50%;width:46px;height:46px;border-radius:50%;transform:translate(-50%,-50%);background:#06b6d4aa}
</style>
</head>
<body>
<canvas id="cv"></canvas>

<div class="hud">
  <span id="fps" class="pill">— FPS</span>
  <span id="you" class="pill">أنا: 0</span>
  <span id="bots" class="pill">Bots: —</span>
</div>
<div class="side">
  <div class="muted" style="margin-bottom:6px">التحكم: الأسهم/WASD أو المسّ</div>
  <div class="list" id="scores"></div>
</div>
<div class="stick" id="stick"><div class="dot" id="dot"></div></div>

<script>
/* ---- الإعدادات العامة ---- */
const WORLD = { w: 2600, h: 2600 };
const PELLETS_TARGET = 320;   // عدد الأكل في العالم
const CAPTURE_RATIO = 1.15;   // لازم تكون أكبر من الخصم بنسبة 15% على الأقل لابتلاعه
const PHYS_HZ = 60;

/* ---- الرسم وتهيئة الشاشة ---- */
const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
function resize(){ cv.width=innerWidth*devicePixelRatio; cv.height=innerHeight*devicePixelRatio; }
addEventListener('resize', resize, {passive:true}); resize();

/* ---- عناصر اللعبة ---- */
function rnd(a,b){ return a + Math.random()*(b-a); }
function hsl(h){ return `hsl(${h},80%,55%)`; }

function makePlayer(name, color, x, y){
  return {name, color, x, y, r: 28, vx:0, vy:0, dx:0, dy:0, score:0, ai:null};
}
const you = makePlayer('أنت', '#00c2d6', rnd(400,WORLD.w-400), rnd(400,WORLD.h-400));
const entities = [you]; // أول عنصر هو اللاعب
const pellets = [];

/* ---- توليد بوتات بمستويات ----
   نوع timid: يهرب من الأكبر/نادراً يطارد، يبحث أكل.
   نوع normal: متوازن.
   نوع aggressive: يطارد الأصغر بقوة ويجازف.
*/
const BOT_TYPES = [
  {name:'timid',  hue:200, speedK:1.05,  bravery:0.2,  caution:1.2},
  {name:'normal', hue:120, speedK:1.00,  bravery:0.6,  caution:1.0},
  {name:'agro',   hue:350, speedK:1.10,  bravery:0.95, caution:0.8},
];
function spawnBot(i){
  const t = BOT_TYPES[i % BOT_TYPES.length];
  const b = makePlayer(`${t.name}#${Math.floor(Math.random()*99)}`, hsl(t.hue), rnd(200,WORLD.w-200), rnd(200,WORLD.h-200));
  b.ai = {type:t, target:null, jitter:rnd(0,Math.PI*2)};
  entities.push(b);
}
for(let i=0;i<8;i++) spawnBot(i); // 8 بوتات
document.getElementById('bots').textContent = 'Bots: '+(entities.length-1);

function spawnPellets(){
  while(pellets.length < PELLETS_TARGET){
    pellets.push({x:rnd(60,WORLD.w-60), y:rnd(60,WORLD.h-60), r:4});
  }
}
spawnPellets();

/* ---- مدخلات: كيبورد + عصاية لمس ---- */
const input = {dx:0,dy:0};
addEventListener('keydown', e=>{
  if(['ArrowUp','w','W'].includes(e.key)) input.dy=-1;
  if(['ArrowDown','s','S'].includes(e.key)) input.dy= 1;
  if(['ArrowLeft','a','A'].includes(e.key)) input.dx=-1;
  if(['ArrowRight','d','D'].includes(e.key)) input.dx= 1;
});
addEventListener('keyup', e=>{
  if(['ArrowUp','w','W','ArrowDown','s','S'].includes(e.key)) input.dy=0;
  if(['ArrowLeft','a','A','ArrowRight','d','D'].includes(e.key)) input.dx=0;
});
const stick = document.getElementById('stick'), dot = document.getElementById('dot');
let dragging=false, center={x:0,y:0};
function startStick(e){ dragging=true; const t=e.touches?e.touches[0]:e; center={x:t.clientX,y:t.clientY}; stick.style.left=(center.x-60)+'px'; stick.style.top=(center.y-60)+'px'; moveStick(e); }
function moveStick(e){ if(!dragging) return; const t=e.touches?e.touches[0]:e; const dx=t.clientX-center.x, dy=t.clientY-center.y; const L=Math.hypot(dx,dy)||1; const max=44; const nx = Math.max(-1,Math.min(1,dx/L)), ny = Math.max(-1,Math.min(1,dy/L)); input.dx=nx; input.dy=ny; dot.style.transform=`translate(${nx*max}px,${ny*max}px)`; }
function endStick(){ dragging=false; input.dx=input.dy=0; dot.style.transform='translate(-50%,-50%)'; }
addEventListener('pointerdown', startStick); addEventListener('pointermove', moveStick); addEventListener('pointerup', endStick);
addEventListener('touchstart', startStick, {passive:false}); addEventListener('touchmove', moveStick, {passive:false}); addEventListener('touchend', endStick, {passive:false});

/* ---- فيزياء وحركة ---- */
function moveEntity(p, dt){
  // السرعة تقل مع الحجم
  const base = 280; // px/s
  const spd = (base / Math.sqrt(p.r)) * (p.ai ? p.ai.type.speedK : 1);
  const len = Math.hypot(p.dx, p.dy) || 1;
  p.vx = (p.dx/len) * spd;
  p.vy = (p.dy/len) * spd;
  p.x = Math.max(0, Math.min(WORLD.w, p.x + p.vx*dt));
  p.y = Math.max(0, Math.min(WORLD.h, p.y + p.vy*dt));
}

function eatPellets(p){
  for(let i=pellets.length-1;i>=0;i--){
    const f=pellets[i];
    if(Math.hypot(p.x-f.x,p.y-f.y) < p.r){
      pellets.splice(i,1);
      // زيادة المساحة = تكبير نصف القطر
      const area = Math.PI*p.r*p.r + Math.PI*f.r*f.r*0.8;
      p.r = Math.sqrt(area/Math.PI);
      p.score += 1;
    }
  }
}

function mergePlayers(A,B){
  const big = A.r>B.r ? A : B, small = A.r>B.r ? B : A;
  if(big.r < small.r*CAPTURE_RATIO) return false;
  if(Math.hypot(A.x-B.x, A.y-B.y) < Math.max(A.r,B.r)*0.85){
    // دمج
    const area = Math.PI*big.r*big.r + Math.PI*small.r*small.r*0.9;
    big.r = Math.sqrt(area/Math.PI);
    big.score += Math.max(1, Math.floor(small.r/2));
    // إعادة إحياء الصغير
    small.x=rnd(200,WORLD.w-200); small.y=rnd(200,WORLD.h-200);
    small.r=26; small.score=0;
    return true;
  }
  return false;
}

/* ---- ذكاء البوتات ---- */
function botThink(b){
  const t = b.ai.type;
  // أقرب تهديد (أكبر منك قريب)
  let threat=null, threatD=1e9;
  for(const o of entities){
    if(o===b) continue;
    if(o.r > b.r*1.08){ // أكبر شوية
      const d=Math.hypot(o.x-b.x,o.y-b.y);
      if(d<threatD){ threat=o; threatD=d; }
    }
  }
  // أقرب فريسة (أصغر منك بفرق جيد)
  let prey=null, preyD=1e9;
  for(const o of entities){
    if(o===b) continue;
    if(b.r > o.r*1.2){ // أنا أكبر بوضوح
      const d=Math.hypot(o.x-b.x,o.y-b.y);
      if(d<preyD){ prey=o; preyD=d; }
    }
  }
  // أقرب أكل
  let food=null, foodD=1e9;
  for(let i=0;i<pellets.length;i++){
    const f=pellets[i]; const d=Math.hypot(f.x-b.x,f.y-b.y);
    if(d<foodD){ food=f; foodD=d; }
  }

  // القرار:
  const fleeBias = t.caution * 1.0;
  const chaseBias= t.bravery * 1.0;

  let tx=b.x, ty=b.y; // هدف الحركة
  if(threat && threatD < 400*fleeBias){ // اهرب
    const dx = b.x - threat.x, dy = b.y - threat.y;
    const L=Math.hypot(dx,dy)||1; tx=b.x + (dx/L)*200; ty=b.y + (dy/L)*200;
  } else if(prey && Math.random()<chaseBias){ // اطارد
    tx = prey.x; ty = prey.y;
  } else if(food){ // روح للأكل
    tx = food.x; ty = food.y;
  }

  // ضف شوية عشوائية رايقة
  b.ai.jitter += 0.02;
  tx += Math.cos(b.ai.jitter)*10; ty += Math.sin(b.ai.jitter)*10;

  const dx=tx-b.x, dy=ty-b.y, L=Math.hypot(dx,dy)||1;
  b.dx = dx/L; b.dy = dy/L;
}

/* ---- حلقة التحديث ---- */
let acc=0, last=performance.now(), frames=0, fpst=0, lastFPS=performance.now();
function frame(ts){
  // FPS
  frames++; if(ts-lastFPS>1000){ fpst=frames; frames=0; lastFPS=ts; document.getElementById('fps').textContent=fpst+' FPS'; }

  // dt ثابت للفيزياء
  const dt = (ts-last)/1000; last=ts; acc += dt;
  const step = 1/PHYS_HZ;
  while(acc>=step){
    // مدخلات اللاعب
    you.dx = input.dx; you.dy = input.dy;
    // AI bots
    for(let i=1;i<entities.length;i++) botThink(entities[i]);
    // حركة الجميع
    for(const p of entities){ moveEntity(p, step); eatPellets(p); }
    // دمج/ابتلاع
    for(let i=0;i<entities.length;i++){
      for(let j=i+1;j<entities.length;j++){
        mergePlayers(entities[i], entities[j]);
      }
    }
    spawnPellets();
    acc -= step;
  }
  draw();
  requestAnimationFrame(frame);
}
requestAnimationFrame(frame);

/* ---- الرسم ---- */
function draw(){
  const dpr = devicePixelRatio||1;
  // كاميرا تتبع اللاعب
  const zoomTarget = Math.max(0.5, Math.min(1.25, 90/Math.sqrt(you.r)));
  draw.camZ = draw.camZ ?? zoomTarget;
  draw.camZ += (zoomTarget - draw.camZ)*0.08;

  const camX = you.x, camY = you.y, Z = draw.camZ*dpr;

  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.save();
  ctx.translate(cv.width/2, cv.height/2);
  ctx.scale(Z, Z);
  ctx.translate(-camX, -camY);

  // خلفية شبكية خفيفة
  ctx.strokeStyle = '#0d1b2a';
  ctx.lineWidth = 1;
  for(let x=0;x<=WORLD.w;x+=120){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,WORLD.h); ctx.stroke(); }
  for(let y=0;y<=WORLD.h;y+=120){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(WORLD.w,y); ctx.stroke(); }

  // الأكل
  ctx.fillStyle = '#ffd166';
  for(const f of pellets){ ctx.beginPath(); ctx.arc(f.x,f.y,f.r,0,Math.PI*2); ctx.fill(); }

  // اللاعبين (بوتات + أنت)
  for(const p of entities){
    ctx.save();
    ctx.shadowColor = p.color+'66'; ctx.shadowBlur = 12;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    // الاسم
    ctx.fillStyle='#eaf2ff'; ctx.font='bold 14px system-ui'; ctx.textAlign='center';
    ctx.fillText(p.name, p.x, p.y - p.r - 12);
    ctx.restore();
  }
  ctx.restore();

  // HUD
  document.getElementById('you').textContent = 'أنا: '+Math.floor(you.r);
  // scoreboard
  const sorted=[...entities].sort((a,b)=>b.r-a.r).slice(0,10);
  document.getElementById('scores').innerHTML = sorted.map((p,i)=>`<div>${i+1}. ${p===you?'👤 ':''}${p.name} — <b>${Math.floor(p.r)}</b></div>`).join('');
}
</script>
</body>
</html>
