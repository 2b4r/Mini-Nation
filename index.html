<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Mini‑Nation — SVG Map</title>
<style>
  :root{--bg:#0f172a;--panel:#0b1220;--muted:#94a3b8;--border:#1f2937;--p:#06b6d4;--ai:#f43f5e;--n:#64748b;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#fff;font:15px/1.5 system-ui,Segoe UI,Arial}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);position:sticky;top:0;background:#0f172acc}
  .pill{background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:#cbd5e1;font-size:12px}
  .wrap{max-width:1100px;margin:0 auto;padding:12px;display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1000px){.wrap{grid-template-columns:680px 1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#142033;color:#dbeafe;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)} .btn:disabled{opacity:.5;cursor:not-allowed}
  svg{width:100%;height:auto;border:1px solid var(--border);border-radius:14px;background:linear-gradient(#0b1426,#0a1630)}
  .reg{stroke:#0f273f;stroke-width:2}
  .reg.sel{filter:drop-shadow(0 0 6px #fff6)}
  .lbl{font:700 12px system-ui;fill:#e2e8f0;pointer-events:none}
  .hint{font-size:12px;color:#9fb9d6}
</style>
</head>
<body>
<header>
  <div class="row">
    <span class="pill">🗺️ Mini‑Nation (SVG)</span>
  </div>
  <div class="row">
    <span id="turnPill" class="pill">الدور: 1</span>
    <span id="ownPill"  class="pill">أقاليمك: —</span>
    <span id="goldPill" class="pill">الذهب: —</span>
  </div>
</header>

<div class="wrap">
  <!-- خريطة SVG بأقاليم (9 أقاليم على شكل بلاطات غير منتظمة + حدود مشتركة) -->
  <svg id="map" viewBox="0 0 680 480" xmlns="http://www.w3.org/2000/svg" aria-label="map">
    <!-- صف علوي -->
    <path id="r0" class="reg" d="M20,20 L220,20 L210,100 L40,120 Z"/>
    <path id="r1" class="reg" d="M220,20 L440,20 L460,110 L210,100 Z"/>
    <path id="r2" class="reg" d="M440,20 L660,20 L640,120 L460,110 Z"/>
    <!-- صف وسط -->
    <path id="r3" class="reg" d="M40,120 L210,100 L230,240 L60,250 Z"/>
    <path id="r4" class="reg" d="M210,100 L460,110 L470,250 L230,240 Z"/>
    <path id="r5" class="reg" d="M460,110 L640,120 L620,260 L470,250 Z"/>
    <!-- صف سفلي -->
    <path id="r6" class="reg" d="M60,250 L230,240 L220,420 L40,400 Z"/>
    <path id="r7" class="reg" d="M230,240 L470,250 L480,420 L220,420 Z"/>
    <path id="r8" class="reg" d="M470,250 L620,260 L640,460 L480,420 Z"/>
    <!-- Labels -->
    <g id="labels" >
      <text class="lbl" x="110" y="80">0</text>
      <text class="lbl" x="330" y="80">0</text>
      <text class="lbl" x="550" y="80">0</text>
      <text class="lbl" x="120" y="190">0</text>
      <text class="lbl" x="340" y="190">0</text>
      <text class="lbl" x="540" y="200">0</text>
      <text class="lbl" x="120" y="330">0</text>
      <text class="lbl" x="340" y="340">0</text>
      <text class="lbl" x="560" y="360">0</text>
    </g>
  </svg>

  <div class="panel">
    <h3>لوحة التحكم</h3>
    <div id="info" class="hint">اضغط إقليم تملكه لتحديده، ثم اضغط إقليمًا مجاورًا للهجوم.</div>
    <div class="row" style="margin:8px 0">
      <button id="btnTrain"  class="btn">تدريب +2 (5💰)</button>
      <button id="btnInvest" class="btn">استثمار +1 صناعة (6💰)</button>
      <button id="btnAttack" class="btn" disabled>هجوم</button>
      <button id="btnEnd"    class="btn">إنهاء الدور</button>
      <button id="btnNew"    class="btn">بداية جديدة</button>
    </div>
    <div class="row">
      <div class="pill">🎖️ قوات: <b id="stTroops">—</b></div>
      <div class="pill">🏭 صناعة: <b id="stInd">—</b></div>
      <div class="pill">🛡️ دفاع: <b id="stDef">—</b></div>
      <div class="pill">👥 سكان: <b id="stPop">—</b></div>
    </div>
    <p id="log" class="hint" style="margin-top:8px">جاهز.</p>
  </div>

  <div class="panel">
    <h3>الوضع العام</h3>
    <div class="row">
      <div class="pill" style="background:#062532;border-color:#0c445a">أنت: <b id="pOwn">—</b></div>
      <div class="pill" style="background:#2a0e16;border-color:#5a0c1d">الخصم: <b id="aOwn">—</b></div>
      <div class="pill" style="background:#1f2937;border-color:#0f273f">محايد: <b id="nOwn">—</b></div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== ألوان الملكية =====
  const COL_P='var(--p)', COL_A='var(--ai)', COL_N='var(--n)';

  // ===== بيانات الأقاليم (9) و الجوار (مشترِك حدود) =====
  const regs=[...document.querySelectorAll('.reg')];
  const lbls=[...document.querySelectorAll('#labels .lbl')]; // لترقيم القوات
  const adj = {
    0:[1,3], 1:[0,2,4], 2:[1,5],
    3:[0,4,6],4:[1,3,5,7],5:[2,4,8],
    6:[3,7], 7:[4,6,8], 8:[5,7]
  };

  // owner: 0 player, 1 AI, 2 neutral
  let prov = Array.from({length:9}, (_,i)=>({
    owner: i%3===0?0 : (i%3===1?1:2),
    troops: 2 + (i%3===0?2:0),
    ind: (i%4===0)?2:1,
    def: (i%5===0)?2:1,
    pop: 2 + (i%3===2?1:0)
  }));

  // اقتصاد
  let goldP=14, goldA=14, turn=1;

  // اختيار
  let from=null, to=null;

  // UI refs
  const info=document.getElementById('info'), log=document.getElementById('log');
  const turnPill=document.getElementById('turnPill'), ownPill=document.getElementById('ownPill'), goldPill=document.getElementById('goldPill');
  const pOwn=document.getElementById('pOwn'), aOwn=document.getElementById('aOwn'), nOwn=document.getElementById('nOwn');
  const stTroops=document.getElementById('stTroops'), stInd=document.getElementById('stInd'), stDef=document.getElementById('stDef'), stPop=document.getElementById('stPop');
  const btnTrain=document.getElementById('btnTrain'), btnInvest=document.getElementById('btnInvest'), btnAttack=document.getElementById('btnAttack'), btnEnd=document.getElementById('btnEnd'), btnNew=document.getElementById('btnNew');

  // ===== أدوات =====
  function counts(){
    let cP=0,cA=0,cN=0;
    for(const p of prov){ if(p.owner===0)cP++; else if(p.owner===1)cA++; else cN++; }
    return {cP,cA,cN};
  }
  function income(owner){
    let s=0; for(const p of prov) if(p.owner===owner) s += (p.ind + p.pop); return s;
  }
  function setFill(i){
    regs[i].style.fill = prov[i].owner===0? getComputedStyle(document.documentElement).getPropertyValue('--p')
      : prov[i].owner===1? getComputedStyle(document.documentElement).getPropertyValue('--ai')
      : getComputedStyle(document.documentElement).getPropertyValue('--n');
  }
  function refresh(){
    regs.forEach((r,i)=>{ setFill(i); r.classList.remove('sel'); lbls[i].textContent = prov[i].troops; });
    if(from!=null) regs[from].classList.add('sel');
    if(to!=null) regs[to].classList.add('sel');
    const {cP,cA,cN}=counts();
    pOwn.textContent=cP; aOwn.textContent=cA; nOwn.textContent=cN;
    ownPill.textContent='أقاليمك: '+cP;
    goldPill.textContent='الذهب: '+goldP;
    turnPill.textContent='الدور: '+turn;
    updateButtons();
    showStats(from ?? to ?? 0);
  }
  function showStats(i){
    const p=prov[i]||{troops:'—',ind:'—',def:'—',pop:'—'};
    stTroops.textContent=p.troops; stInd.textContent=p.ind; stDef.textContent=p.def; stPop.textContent=p.pop;
  }
  function updateButtons(){
    btnTrain.disabled = !(from!=null && prov[from].owner===0 && goldP>=5);
    btnInvest.disabled= !(from!=null && prov[from].owner===0 && goldP>=6);
    btnAttack.disabled = !(from!=null && to!=null && prov[from].owner===0 && prov[to].owner!==0 && adj[from].includes(to) && prov[from].troops>=2);
  }
  function logMsg(s){ log.textContent=s; }

  // ===== تفاعل الخريطة =====
  regs.forEach((el,i)=>{
    el.addEventListener('click', ()=>{
      if(from==null){
        if(prov[i].owner!==0){ logMsg('اختر إقليم تملكه.'); return; }
        from=i; to=null; info.textContent='اختر جارًا للتركيز/الهجوم أو استخدم تدريب/استثمار.'; showStats(i);
      }else if(to==null){
        if(i===from){ from=null; to=null; info.textContent='تم إلغاء التحديد.'; }
        else if(adj[from].includes(i)){ to=i; showStats(i); info.textContent = (prov[i].owner===0)? 'جارٍ تابع لك.' : 'جارٍ عدو/محايد — جاهز للهجوم.'; }
        else { logMsg('هذا الإقليم ليس مجاورًا للمصدر.'); }
      }else{
        // إذا كان already from & to، الضغط يغيّر المصدر لو ملكك
        if(prov[i].owner===0){ from=i; to=null; showStats(i); }
        else { to=i; showStats(i); }
      }
      refresh();
    });
  });

  // ===== أزرار الإجراءات =====
  btnTrain.onclick=()=>{
    if(from==null) return;
    const p=prov[from]; if(p.owner!==0||goldP<5) return;
    p.troops+=2; goldP-=5; logMsg('تدريب +2 قوات.'); refresh();
  };
  btnInvest.onclick=()=>{
    if(from==null) return;
    const p=prov[from]; if(p.owner!==0||goldP<6) return;
    p.ind+=1; goldP-=6; logMsg('استثمار +1 صناعة.'); refresh();
  };
  btnAttack.onclick=()=>{
    if(!(from!=null&&to!=null)) return;
    const A=prov[from], D=prov[to];
    if(A.owner!==0||D.owner===0||!adj[from].includes(to)) return;
    const send=Math.max(1, Math.floor(A.troops/2));
    A.troops-=send;
    const atk = send*(1+0.15*A.ind)*(0.85+Math.random()*0.3);
    const def = D.troops*(1+0.15*D.def)*(0.85+Math.random()*0.3);
    if(atk>def){
      const remain=Math.max(1, Math.floor(send - def/(1+0.15*A.ind)));
      D.owner=0; D.troops=remain; logMsg('✅ انتصرت وسيطرت على الإقليم.');
    }else{
      const loss=Math.max(1, Math.floor(atk/(1+0.15*D.def)));
      D.troops=Math.max(0, D.troops - loss); logMsg('❌ الهجوم فشل جزئيًا.');
    }
    checkWin(); refresh();
  };

  btnEnd.onclick=()=>{
    // دخلك
    goldP += income(0);
    for(const p of prov) if(p.owner===0 && Math.random()<0.25) p.troops++;

    // دور الخصم
    aiTurn();

    turn++; logMsg('بدأ دور جديد.'); refresh();
  };

  btnNew.onclick=()=>{ newGame(); };

  // ===== فوز/خسارة =====
  function checkWin(){
    const {cP,cA}=counts();
    if(cP>=6){ logMsg('🏆 فوز — سيطرت على أغلب الأقاليم!'); disableAll(); }
    if(cA>=6){ logMsg('💀 خسارة — الخصم تمدد!'); disableAll(); }
  }
  function disableAll(){
    btnTrain.disabled=btnInvest.disabled=btnAttack.disabled=btnEnd.disabled=true;
    regs.forEach(r=>r.style.pointerEvents='none');
  }

  // ===== ذكاء الخصم بسيط =====
  function aiTurn(){
    goldA += income(1);
    // يحاول يهاجم أضعف جار
    let moves=[];
    for(let i=0;i<9;i++) if(prov[i].owner===1){
      for(const j of adj[i]) if(prov[j].owner!==1){
        moves.push({from:i,to:j});
      }
    }
    moves.sort((A,B)=> prov[A.to].troops - prov[B.to].troops);
    let acted=false;
    for(const m of moves){
      const a=prov[m.from], d=prov[m.to];
      if(a.troops>=3 && Math.random()<0.8){
        const send=Math.max(1, Math.floor(a.troops/2));
        a.troops-=send;
        const atk = send*(1+0.15*a.ind)*(0.85+Math.random()*0.3);
        const def = d.troops*(1+0.15*d.def)*(0.85+Math.random()*0.3);
        if(atk>def){
          const remain=Math.max(1, Math.floor(send - def/(1+0.15*a.ind)));
          d.owner=1; d.troops=remain; logMsg('⚠️ الخصم سيطر على إقليم.');
        }else{
          const loss=Math.max(1, Math.floor(atk/(1+0.15*d.def)));
          d.troops=Math.max(0, d.troops - loss); logMsg('الخصم هاجم وفشل جزئيًا.');
        }
        acted=true; break;
      }
    }
    if(!acted){
      // استثمار/تدريب
      const aiIdx = prov.map((p,i)=>[p,i]).filter(x=>x[0].owner===1).map(x=>x[1]);
      if(aiIdx.length){
        const k=aiIdx[Math.floor(Math.random()*aiIdx.length)];
        const p=prov[k];
        if(goldA>=6 && Math.random()<0.5){ p.ind++; goldA-=6; }
        else if(goldA>=5){ p.troops+=2; goldA-=5; }
        else if(Math.random()<0.3){ p.troops++; }
      }
    }
    checkWin();
  }

  // ===== لعبة جديدة =====
  function newGame(){
    prov = Array.from({length:9}, (_,i)=>({
      owner: i%3===0?0 : (i%3===1?1:2),
      troops: 2 + (i%3===0?2:0),
      ind: (i%4===0)?2:1,
      def: (i%5===0)?2:1,
      pop: 2 + (i%3===2?1:0)
    }));
    regs.forEach(r=>r.style.pointerEvents='auto');
    goldP=14; goldA=14; turn=1; from=null; to=null;
    logMsg('بداية جديدة.'); refresh();
  }

  // ===== بدء =====
  refresh(); logMsg('جاهز: اختر إقليمك ثم جارًا للهجوم أو استخدم تدريب/استثمار.');
})();
</script>
</body>
</html>
